<Project Sdk="Microsoft.DotNet.Helix.Sdk" DefaultTargets="SubmitTestsToHelix">

  <!-- This project uses the helix SDK, documented at
       https://github.com/dotnet/arcade/tree/master/src/Microsoft.DotNet.Helix/Sdk,
       to send test jobs to helix. -->

  <Import Project="..\dir.props" />

  <PropertyGroup>
    <HelixArchitecture>$(BuildArch)</HelixArchitecture>
    <HelixConfiguration Condition=" '$(Scenario)' == '' ">$(BuildType)</HelixConfiguration>
    <HelixConfiguration Condition=" '$(Scenario)' != '' ">$(BuildType)-$(Scenario)</HelixConfiguration>

    <IsExternal>$(_IsExternal)</IsExternal>
    <IsExternal Condition=" '$(IsExternal)' == '' ">true</IsExternal>

    <Creator Condition=" '$(IsExternal)' == 'true' ">$(_Creator)</Creator>
    <HelixAccessToken Condition=" '$(IsExternal)' != 'true' ">$(_HelixAccessToken)</HelixAccessToken>
    <HelixTargetQueues>$(_HelixTargetQueues)</HelixTargetQueues>

    <EnableAzurePipelinesReporter>$(_PublishTestResults)</EnableAzurePipelinesReporter>
    <EnableAzurePipelinesReporter Condition=" '$(EnableAzurePipelinesReporter)' == '' ">false</EnableAzurePipelinesReporter>

    <HelixBuild>$(_HelixBuild)</HelixBuild>
    <HelixSource>$(_HelixSource)</HelixSource>
    <HelixType>$(_HelixType)</HelixType>

    <TimeoutInMinutes>$(_TimeoutInMinutes)</TimeoutInMinutes>
    <TimeoutInMinutes Condition=" '$(TimeoutInMinutes)' == '' ">5</TimeoutInMinutes>

    <WaitForWorkItemCompletion>true</WaitForWorkItemCompletion>
    <CoreRootDirectory>$(TestWorkingDir)\Tests\Core_Root</CoreRootDirectory>
    <TestEnvFileExtension Condition=" '$(TargetsWindows)' == 'true' ">.cmd</TestEnvFileExtension>
    <TestEnvFileExtension Condition=" '$(TargetsWindows)' != 'true' ">.sh</TestEnvFileExtension>
  </PropertyGroup>

  <ItemGroup>
    <HelixCorrelationPayload Include="$(CoreRootDirectory)" />
    <XUnitWrapperDlls Include="$(TestWorkingDir)\**\*.XUnitWrapper.dll" />
    <Scenarios Include="$(_Scenarios.Split(','))" />
  </ItemGroup>

  <Target Name="CreateTestEnvFiles">
    <ItemGroup>
      <_XUnitWrapperDirectoryWithScenario Include="@(XUnitWrapperDlls->'%(RootDir)%(Directory)')">
        <Scenario>%(Scenarios.Identity)</Scenario>
      </_XUnitWrapperDirectoryWithScenario>

      <_ProjectsToBuild Include=".\testenvironment.proj">
        <Properties>Scenario=%(_XUnitWrapperDirectoryWithScenario.Scenario);TestEnvFileName=%(Identity)\SetStressModes_%(Scenario)$(TestEnvFileExtension);TargetsWindows=$(TargetsWindows)</Properties>
      </_ProjectsToBuild>
    </ItemGroup>

    <MSBuild Projects="@(_ProjectsToBuild)" Targets="CreateTestEnvFile" BuildInParallel="false" StopOnFirstFailure="true" UnloadProjectsOnCompletion="true" />

    <ItemGroup>
      <_ProjectsToBuild Remove="@(_ProjectsToBuild)" />
    </ItemGroup>
  </Target>

  <Target Name="SubmitTestsToHelix" DependsOnTargets="CreateTestEnvFiles">
    <ItemGroup>
      <_ProjectsToBuild Include="$(MSBuildProjectFile)">
        <Properties>Scenario=%(Scenarios.Identity)</Properties>
      </_ProjectsToBuild>
    </ItemGroup>

    <PropertyGroup>
      <_BuildInParallel>false</_BuildInParallel>
      <_BuildInParallel Condition=" '@(_ProjectsToBuild->Count())' > '1' ">true</_BuildInParallel>
    </PropertyGroup>

    <MSBuild Projects="@(_ProjectsToBuild)" Targets="Test" BuildInParallel="$(_BuildInParallel)" StopOnFirstFailure="false" UnloadProjectsOnCompletion="true" />

    <ItemGroup>
      <_ProjectsToBuild Remove="@(_ProjectsToBuild)" />
    </ItemGroup>
  </Target>

  <Target Name="BuildHelixWorkItem" BeforeTargets="Test">
    <PropertyGroup>
      <!-- The "normal" scenario is just a way to include the default
           (empty) scenario when specifying multiple scenarios at
           once. From here, on, treat it as the empty scenario so that
           job names will not have a scenario prefix and the runtest
           script doesn't have to define a "normal" scenario. -->
      <Scenario Condition=" '$(Scenario)' == 'normal' "></Scenario>
      <TestRunNamePrefix Condition=" '$(Scenario)' == '' ">$(BuildOS) $(BuildArch) $(BuildType) @ </TestRunNamePrefix>
      <TestRunNamePrefix Condition=" '$(Scenario)' != '' ">$(BuildOS) $(BuildArch) $(BuildType) $(Scenario) @ </TestRunNamePrefix>
      <_XUnitRunnerArgs>-parallel collections -nocolor -noshadow -xml testResults.xml -notrait category=outerloop -notrait category=failing</_XUnitRunnerArgs>
    </PropertyGroup>

    <PropertyGroup Condition=" '$(TargetsWindows)' == 'true' ">
      <_CoreRun>%HELIX_CORRELATION_PAYLOAD%\CoreRun.exe</_CoreRun>
      <_XUnitRunnerDll>%HELIX_CORRELATION_PAYLOAD%\xunit.console.dll</_XUnitRunnerDll>

      <_SetCoreRoot>set CORE_ROOT=%HELIX_CORRELATION_PAYLOAD%</_SetCoreRoot>
      <_SetTestEnv>set __TestEnv=%HELIX_WORKITEM_PAYLOAD%\SetStressModes_$(Scenario)$(TestEnvFileExtension)</_SetTestEnv>
      <_OutputTestEnvFile>type %__TestEnv%</_OutputTestEnvFile>
    </PropertyGroup>

    <PropertyGroup Condition=" '$(TargetsWindows)' != 'true' ">
      <_CoreRun>$HELIX_CORRELATION_PAYLOAD/corerun</_CoreRun>
      <_XUnitRunnerDll>$HELIX_CORRELATION_PAYLOAD/xunit.console.dll</_XUnitRunnerDll>

      <_SetCoreRoot>export CORE_ROOT=$HELIX_CORRELATION_PAYLOAD</_SetCoreRoot>
      <_SetTestEnv>export __TestEnv=$HELIX_WORKITEM_PAYLOAD/SetStressModes_$(Scenario)$(TestEnvFileExtension)</_SetTestEnv>
      <_OutputTestEnvFile>cat $__TestEnv</_OutputTestEnvFile>
    </PropertyGroup>

    <ItemGroup>
      <HelixWorkItem Include="@(XUnitWrapperDlls->'%(FileName)'->Replace('.XUnitWrapper', ''))">
        <PayloadDirectory>%(RootDir)%(Directory)</PayloadDirectory>
        <PreCommands>$(_SetCoreRoot);$(_SetTestEnv);$(_OutputTestEnvFile)</PreCommands>
        <Command>$(_CoreRun) $(_XUnitRunnerDll) %(FileName)%(Extension) $(_XUnitRunnerArgs)</Command>
        <Timeout>$([System.TimeSpan]::FromMinutes($(TimeoutInMinutes)))</Timeout>
      </HelixWorkItem>
    </ItemGroup>
  </Target>

</Project>
